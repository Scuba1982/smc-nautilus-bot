# Multi-SMC Crypto Trading Bot (Nautilus Trader)

Усовершенствованный торговый бот для криптовалютного рынка (Spot), построенный на базе высокопроизводительного фреймворка **Nautilus Trader**. 

Бот использует методологию **Smart Money Concepts (SMC)** для определения зон интереса (Optimal Trade Entry - OTE) и алгоритмы машинного обучения (**XGBoost**) для микроструктурного анализа и предсказания вероятности успешной отработки сделки в реальном времени.

## Архитектура системы

Система разделена на несколько логических слоев:
1. **Слой данных (Data Engine):** Подключение к биржам (Binance), сбор сырых потоков сделок (Trade Ticks).
2. **Слой агрегации (Packet Builder):** Склейка сырых сделок в доллоровые пакеты (Volume Buckets) с расчетом микроструктурных метрик (VPIN, Imbalance, Volatility).
3. **Слой детекции (SMC Detector):** Выявление слома структуры (BOS) и построение диапазонов (Dealing Range) на основе сформированных пакетов.
4. **Слой принятия решений (XGBoost Model):** Оценка микроструктурного состояния рынка внутри зоны OTE.
5. **Слой исполнения (Strategy & Execution):** Высокотехнологичная маршрутизация ордеров (Advance Limit Placement с упреждающей отменой).
6. **Пользовательский интерфейс (Flask + UI):** Мониторинг портфеля, управление позициями и визуализация графиков со структурами SMC.

---

## Описание основных файлов проекта

### 1. Ядро Торговой Стратегии
* **`smc_nautilus_strategy.py`** — Главный файл стратегии (`MultiSMCStrategy`), работающий внутри движка Nautilus Trader.
  * *Логика:* Подписывается на потоки сделок (Trade Ticks), обновляет бакеты, ищет сигналы OTE. 
  * *Исполнение:* Реализует сложный алгоритм упреждающего входа. Заранее выставляет `LIMIT` ордера (сбор Maker-комиссий) на уровень Sweet Spot (70.5%) при обнаружении зоны OTE. На подходе цены к лимитке тестирует рынок через XGBoost-модель и мгновенно отменяет ордер (`Dynamic Cancel`), если предсказание падает ниже порога.
* **`smc_detector.py`** — Модуль технического анализа структуры (Smart Money Concepts).
  * Исследует историю пакетов для нахождения `Swing High` и `Swing Low`. 
  * Фиксирует пробой структуры (Bullish BOS / Bearish CHoCH).
  * Рассчитывает координаты зон Фибоначчи: OTE (61.8% - 79%), Sweet Spot (70.5%), структурный Stop Loss и уровни Take Profit.
* **`live_packet_builder.py`** — Модуль агрегации потока сделок (Live Packet Builder).
  * Преобразует непрерывный поток обычных сделок (Tick by Tick) в проприетарные пакеты равного долларового объема (Volume Buckets). Считает внутри каждого пакета `VPIN`, сделки инициаторов покупок/продаж (`imbalance`) и внутрипакетную волатильность по лог-доходностям.
* **`packet_builder_numba.py`** — Оптимизированная версия `live_packet_builder.py` (с использованием `numba` / `jit`), применяемая для сверхбыстрого пересчета исторического датасета перед обучением модели XGBoost.

### 2. Подготовка Данных и ML (Обучение)
* **`features.py`** — Набор дополнительных расчетных микроструктурных функций (например, расчет Efficiency Ratio - ER). Вспомогательный файл для генерации фич для XGboost.
* **`download_data.py`** — Скрипт для массового скачивания исторических Trade-логов с Binance (по API/Архивам), распаковки и конвертации сырых данных в Parquet.
* **`models/`** — Директория для хранения сохраненных весов обученных ML-моделей (паспорта моделей, файлы `.bson` / `.json` от XGBoost).

### 3. Инфраструктура и Сервисы (Backend & UI)
* **`flask_server.py`** — Бэкенд-сервер на Flask + WebSocket (Socket.IO).
  * Служит мостом между ядром `Nautilus Trader` (работающим в отдельном процессе/потоке) и фронтендом.
  * Передает телеметрию (свечи, PnL, вероятности модели, сигналы, статус ордеров) в реальном времени.
  * Принимает команды пользователя на "Ручное закрытие", "Отмену всех ордеров" (`manual_order_queue`).
* **`index.html`** — Мощный крипто-терминал (Frontend Web UI), написанный с использованием Canvas / JS Charts. 
  * Отрисовывает нестандартные барометры (Volume Buckets Type).
  * Визуализирует зоны OTE, уровни TP/SL, микроструктурные осцилляторы (VPIN/Imbalance) и предсказания модели в режиме реального времени.

### 4. Тестирование и Симуляция
* **`live_simulator.py`** — Модуль запуска торгового узла (`TradingNode`) в режиме `Live`, но без отправки реальных денег (Paper Trading). Запускает стратегию в боевой конфигурации с брокером для сбора бумажного профита.
* **`panel_strategy.py`** — Вспомогательный UI-wrapper (возможно на базе библиотеки `Panel` или `Streamlit`), использовался на ранних стадиях для быстрой визуализации логики SMC до написания собственного Flask-сервера.
* **`test_order_execution.py`** — Скрипт-юнит тест движка исполнения. Создает `MockExecutionClient` (эмулятор биржи Binance Spot) для проверки правильности отработки `MARKET` и `LIMIT` ордеров стратегии, вычета комиссий и тестирования поведения динамической отмены ордеров.
* **`test_ob.py`** / **`test_sandbox.py`** / **`test_crash.py`** — Песочницы и мини-скрипты разработчика для проверки отдельных модулей (OrderBook, загрузчика, обработки ошибок и крашей ядра).

### 5. Документация и Конфиги
* **`config.yaml`** — Глобальный конфигурационный файл. Хранит API-ключи, настройки инструментов (символов), размеры пакетов (бакетов) для каждого тикера, порог вероятности модели (threshold) и пути к весам XGBoost.
* **`NautilusTrader_Docs_v1.122_RU.md`** — Внутренняя актуальная документация команды. Содержит критические правила работы с API Nautilus Trader версии 1.122+ (обновление синтаксиса `AccountState`, `OrderFilled`, `generate_account_state` и т.д.).
* **`BACKTEST_GUIDE.md`** — Документация/памятка по проведению бэктестов данной методики или обучению новых моделей на собранных бакетах.

---

## Жизненный цикл типичной сделки (The Execution Workflow)

1. **Trade Ticks:** Биржа (Binance) транслирует сделки. `Nautilus Trader` принимает их и передает в метод `on_trade_tick` класса `MultiSMCStrategy`.
2. **Агрегация:** Стратегия скармливает сделки `live_packet_builder.py`. Как только накапливается заданный `$ USD` объем (например $100к), пакет закрывается и отдается `smc_detector.py`.
3. **Паттерн:** Детектор видит пробой структуры и формирует Dealing Range. Вычисляется точка идеального входа — Sweet Spot OTE (70.5%).
4. **Упреждающий вход (Maker Limit):** Стратегия мгновенно выставляет `LIMIT BUY` на уровень 70.5%. Ордер встает в стакан биржи. Мы фиксируем в памяти его ID, а также расчетные Стоп-Лосс и Тейк-Профит.
5. **Контроль на подходе:** Цена падает. Как только расстояние до нашего лимита становится `< 1%`, стратегия начинает дергать XGBoost модель (`model.predict_proba`). Модель оценивает: "Как именно падает цена? Аномально? Есть ли скрытые покупки?".
6. **Защита (Dynamic Cancel):** Если модель видит дисбаланс и говорит "Плохо" (< 0.5%) — стратегия снимает лимитку с биржи (`cancel_order`), спасая капитал. Иначе — ордер исполняется биржей.
7. **Фиксация и Выход:** Лимитка исполнена. Срабатывает обработчик `on_order_filled`. Стратегия достает зарезервированные TP и SL и отправляет их на биржу (соответственно как LIMIT SELL и STOP MARKET SELL). Позиция защищена со всех сторон. Ожидаем профит.
